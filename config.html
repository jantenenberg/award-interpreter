<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configuration & Data Management – Award Interpreter</title>
    <link rel="stylesheet" href="./styles.css" />
    <style>
      .config-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .config-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .config-section h2 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }
      .config-section h3 {
        margin-top: 24px;
        margin-bottom: 12px;
        color: #34495e;
      }
      .file-path-row {
        display: grid;
        grid-template-columns: 200px 1fr 100px;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 4px;
      }
      .file-path-row label {
        font-weight: 600;
        color: #555;
      }
      .file-path-row input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
      }
      .file-path-row button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .file-path-row button:hover {
        background: #2980b9;
      }
      .relationship-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      .relationship-table th,
      .relationship-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .relationship-table th {
        background: #34495e;
        color: white;
        font-weight: 600;
      }
      .relationship-table tr:hover {
        background: #f5f5f5;
      }
      .issue-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .issue-item {
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid #ffc107;
        background: #fff3cd;
        border-radius: 4px;
      }
      .issue-item.error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .issue-item.warning {
        border-left-color: #ffc107;
        background: #fff3cd;
      }
      .issue-item.info {
        border-left-color: #17a2b8;
        background: #d1ecf1;
      }
      .issue-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 8px;
      }
      .issue-title {
        font-weight: 600;
        color: #333;
      }
      .issue-actions {
        display: flex;
        gap: 8px;
      }
      .btn-small {
        padding: 4px 12px;
        font-size: 0.85em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-fix {
        background: #28a745;
        color: white;
      }
      .btn-fix:hover {
        background: #218838;
      }
      .btn-ignore {
        background: #6c757d;
        color: white;
      }
      .btn-ignore:hover {
        background: #5a6268;
      }
      .override-form {
        margin-top: 12px;
        padding: 12px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .override-form input,
      .override-form select {
        padding: 6px 10px;
        margin: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .override-form button {
        padding: 6px 16px;
        margin: 4px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
      }
      .status-success {
        background: #d4edda;
        color: #155724;
      }
      .status-error {
        background: #f8d7da;
        color: #721c24;
      }
      .status-warning {
        background: #fff3cd;
        color: #856404;
      }
      .save-config-btn {
        padding: 12px 24px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
      }
      .save-config-btn:hover {
        background: #218838;
      }
      .mapping-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }
      .mapping-controls select,
      .mapping-controls input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .mapping-controls button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
    <script type="module" src="./src/data-loader.js"></script>
    <script type="module" src="./src/config-manager.js"></script>
  </head>
  <body>
    <div class="app-container">
      <header class="app-header">
        <div class="app-header-inner">
          <div class="app-brand">
            <img src="./assets/maica-logo.png" alt="Maica logo" class="app-logo" />
            <div class="app-brand-text">
              <h1>Maica Roster Costing Calculator</h1>
              <p>Configure rate overrides, data issues and validation rules</p>
            </div>
          </div>
          <nav class="app-nav">
            <a href="./index.html">Calculator</a>
            <a href="./config.html" style="font-weight:700;text-decoration:underline;">Configuration</a>
            <a href="./documentation.html">Documentation</a>
            <a href="./reference-data.html">Reference Data</a>
          </nav>
        </div>
      </header>

      <main class="config-container">

        <!-- API Connection Section -->
        <section class="config-section">
          <h2>API Connection</h2>
          <p>
            The calculator loads award data from the backend API.
            When running the frontend locally (without the backend), set the base URL of the deployed API here.
            Leave blank when the frontend is served by the FastAPI backend itself (e.g. on Railway).
          </p>
          <div class="file-path-row">
            <label>API Base URL:</label>
            <input type="text" id="apiBaseUrl" placeholder="https://award-interpreter-production.up.railway.app" style="font-family:monospace;" />
            <button onclick="saveApiBaseUrl()">Save</button>
          </div>
          <p id="apiUrlStatus" style="margin-top:8px;font-size:13px;color:#555;"></p>
          <script>
            (function() {
              const saved = localStorage.getItem('apiBaseUrl') || '';
              document.getElementById('apiBaseUrl').value = saved;
              document.getElementById('apiUrlStatus').textContent =
                saved ? `Currently using: ${saved}` : 'Currently using relative paths (default — correct for Railway deployment)';
            })();
            function saveApiBaseUrl() {
              const val = (document.getElementById('apiBaseUrl').value || '').trim().replace(/\/$/, '');
              if (val) {
                localStorage.setItem('apiBaseUrl', val);
                document.getElementById('apiUrlStatus').textContent = `Saved. Reload the Calculator tab to reconnect.`;
              } else {
                localStorage.removeItem('apiBaseUrl');
                document.getElementById('apiUrlStatus').textContent = 'Cleared — using relative paths. Reload the Calculator tab.';
              }
            }
          </script>
        </section>

        <!-- Data Relationships Section -->
        <section class="config-section">
          <h2>Rate Mappings</h2>
          <p>Define classification and penalty rate mappings. These override values from the database tables.</p>

          <h3>2.1 Award-Classification Mapping</h3>
          <div class="mapping-controls">
            <select id="awardSelectMapping">
              <option value="">Select Award</option>
            </select>
            <select id="classificationSelectMapping">
              <option value="">Select Classification</option>
            </select>
            <select id="rateTypeSelectMapping">
              <option value="">Select Rate Type</option>
              <option value="CA">Casual (CA)</option>
              <option value="FT">Full-time (FT)</option>
              <option value="PT">Part-time (PT)</option>
            </select>
            <button onclick="addClassificationMapping()">Add Mapping</button>
          </div>
          <table class="relationship-table">
            <thead>
              <tr>
                <th>Award Code</th>
                <th>Classification</th>
                <th>Rate Type</th>
                <th>Base Rate</th>
                <th>Calculated Rate</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="classificationMappingsTable">
              <tr>
                <td colspan="6" style="text-align: center; color: #999;">No mappings defined. Data will use database values.</td>
              </tr>
            </tbody>
          </table>

          <h3>2.2 Penalty Rate Mappings</h3>
          <div class="info" style="margin-bottom: 12px;">
            <strong>Common fixes:</strong>
            <ul style="margin: 8px 0 0 20px; font-size: 0.9em;">
              <li><strong>Sunday rate:</strong> Description: "Sunday" or "Sunday - ordinary hours", Rate: $39.83 (for $26.55 base × 1.50)</li>
              <li><strong>Saturday flat rate:</strong> Description: "Saturday - ordinary hours", Rate: $33.19 (for $26.55 base × 1.25)</li>
            </ul>
          </div>
          <div class="mapping-controls">
            <select id="penaltyAwardSelect">
              <option value="">Select Award</option>
            </select>
            <select id="penaltyClassificationSelect">
              <option value="">Select Classification</option>
            </select>
            <input type="text" id="penaltyDescription" placeholder="Penalty description (e.g., 'Sunday', 'Saturday - ordinary hours')" style="flex: 1;" />
            <input type="number" id="penaltyRate" placeholder="Rate ($/hr)" step="0.01" style="width: 150px;" />
            <button onclick="addPenaltyMapping()">Add Override</button>
          </div>
          <table class="relationship-table">
            <thead>
              <tr>
                <th>Award</th>
                <th>Classification</th>
                <th>Description</th>
                <th>Rate ($/hr)</th>
                <th>Source</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="penaltyMappingsTable">
              <tr>
                <td colspan="6" style="text-align: center; color: #999;">No overrides defined. Using database values.</td>
              </tr>
            </tbody>
          </table>
        </section>

        <!-- Data Issues Section -->
        <section class="config-section">
          <h2>Data Issues & Fixes</h2>
          <p>Review and fix data validation issues detected by the system.</p>

          <div class="info" style="margin-bottom: 20px;">
            <strong>Quick Fix Guide:</strong>
            <ul style="margin: 8px 0 0 20px;">
              <li><strong>Sunday rate wrong:</strong> Click "Fix" button on the warning, or manually override in Section 4.2</li>
              <li><strong>Saturday using tiered rates:</strong> Override "Saturday - ordinary hours" to use flat ×1.25 rate ($33.19/hr for $26.55 base)</li>
              <li><strong>After fixing:</strong> Reload the main calculator page to see changes</li>
            </ul>
          </div>

          <div id="issuesContainer">
            <ul class="issue-list" id="issuesList">
              <li class="issue-item">
                <div class="issue-header">
                  <div>
                    <span class="issue-title">No issues detected</span>
                    <p style="margin: 8px 0 0 0; color: #666;">Run a calculation to detect data issues.</p>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <div style="margin-top: 20px;">
            <button class="save-config-btn" onclick="scanForIssues()">Scan for Issues</button>
            <button class="save-config-btn" onclick="clearAllOverrides()" style="background: #dc3545; margin-left: 12px;">Clear All Overrides</button>
          </div>
        </section>

        <!-- Rate Overrides Section -->
        <section class="config-section">
          <h2>Rate Overrides</h2>
          <p>Manually override rates when database values need adjustment.</p>

          <h3>4.1 Classification Rate Overrides</h3>
          <table class="relationship-table">
            <thead>
              <tr>
                <th>Award</th>
                <th>Classification</th>
                <th>Rate Type</th>
                <th>Original Rate</th>
                <th>Override Rate</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rateOverridesTable">
              <tr>
                <td colspan="6" style="text-align: center; color: #999;">No overrides defined.</td>
              </tr>
            </tbody>
          </table>

          <div class="mapping-controls" style="margin-top: 16px;">
            <select id="overrideAwardSelect">
              <option value="">Select Award</option>
            </select>
            <select id="overrideClassificationSelect">
              <option value="">Select Classification</option>
            </select>
            <select id="overrideRateTypeSelect">
              <option value="">Rate Type</option>
              <option value="CA">Casual</option>
              <option value="FT">Full-time</option>
              <option value="PT">Part-time</option>
            </select>
            <input type="number" id="overrideRateValue" placeholder="Override rate ($)" step="0.01" />
            <button onclick="addRateOverride()">Add Override</button>
          </div>

          <h3>4.2 Penalty Rate Overrides</h3>
          <p>Override specific penalty rates for award/classification combinations.</p>
          <div id="penaltyOverridesContainer">
            <!-- Populated dynamically -->
          </div>
        </section>

        <!-- Validation Rules Section -->
        <section class="config-section">
          <h2>Validation Rules</h2>
          <p>Configure validation rules and thresholds for data quality checks.</p>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h3>Rate Validation</h3>
              <label style="display: block; margin: 12px 0 4px 0;">
                <input type="checkbox" id="validateSundayRate" checked />
                Validate Sunday rate = casual loaded rate × 1.50
              </label>
              <label style="display: block; margin: 12px 0 4px 0;">
                <input type="checkbox" id="validateSaturdaySunday" checked />
                Warn if Saturday rate exceeds Sunday rate
              </label>
              <label style="display: block; margin: 12px 0 4px 0;">
                <input type="number" id="rateTolerance" value="0.01" step="0.01" min="0" style="width: 100px; margin-left: 8px;" />
                Rate tolerance ($) for validation
              </label>
            </div>
            <div>
              <h3>Minimum Engagement</h3>
              <label style="display: block; margin: 12px 0 4px 0;">
                <input type="checkbox" id="enforceMinimumEngagement" checked />
                Enforce casual minimum engagement (3 hours)
              </label>
              <label style="display: block; margin: 12px 0 4px 0;">
                <input type="number" id="minimumEngagementHours" value="3" step="0.5" min="0" style="width: 100px; margin-left: 8px;" />
                Minimum engagement hours
              </label>
            </div>
          </div>

          <button class="save-config-btn" onclick="saveValidationRules()">Save Validation Rules</button>
        </section>

        <!-- Export/Import Configuration -->
        <section class="config-section">
          <h2>Export / Import Configuration</h2>
          <p>Export your configuration to a JSON file or import from a previously saved configuration.</p>

          <div style="display: flex; gap: 12px;">
            <button class="save-config-btn" onclick="exportConfiguration()" style="background: #17a2b8;">Export Configuration</button>
            <button class="save-config-btn" onclick="importConfiguration()" style="background: #17a2b8;">Import Configuration</button>
            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)" />
          </div>
        </section>
      </main>
    </div>

    <script>
      // Global functions for inline event handlers
      window.addClassificationMapping = function() {
        // Implemented in config-manager.js
        if (window.configManager) {
          window.configManager.addClassificationMapping();
        }
      };

      window.addPenaltyMapping = function() {
        if (window.configManager) {
          window.configManager.addPenaltyMapping();
        }
      };

      window.addRateOverride = function() {
        if (window.configManager) {
          window.configManager.addRateOverride();
        }
      };

      window.scanForIssues = function() {
        if (window.configManager) {
          window.configManager.scanForIssues();
        }
      };

      window.clearAllOverrides = function() {
        if (confirm('Are you sure you want to clear all overrides? This cannot be undone.')) {
          if (window.configManager) {
            window.configManager.clearAllOverrides();
          }
        }
      };

      window.saveValidationRules = function() {
        if (window.configManager) {
          window.configManager.saveValidationRules();
        }
      };

      window.exportConfiguration = function() {
        if (window.configManager) {
          window.configManager.exportConfiguration();
        }
      };

      window.importConfiguration = function() {
        document.getElementById('importFileInput').click();
      };

      window.handleImportFile = function(event) {
        const file = event.target.files[0];
        if (file && window.configManager) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const config = JSON.parse(e.target.result);
              window.configManager.importConfiguration(config);
            } catch (error) {
              alert('Error importing configuration: ' + error.message);
            }
          };
          reader.readAsText(file);
        }
      };

    </script>
  </body>
</html>