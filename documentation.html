<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Award Interpreter - System Documentation</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    h2 {
      color: #34495e;
      margin-top: 40px;
      margin-bottom: 20px;
      padding-bottom: 8px;
      border-bottom: 2px solid #ecf0f1;
    }
    h3 {
      color: #555;
      margin-top: 25px;
      margin-bottom: 12px;
    }
    .section {
      margin-bottom: 40px;
    }
    .file-list {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 6px;
      margin: 15px 0;
    }
    .file-item {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-left: 4px solid #3498db;
      padding-left: 15px;
    }
    .file-item strong {
      color: #2980b9;
      display: block;
      margin-bottom: 5px;
    }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.9em;
      color: #e74c3c;
    }
    pre {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 15px 0;
    }
    pre code {
      background: none;
      color: inherit;
      padding: 0;
    }
    .diagram {
      background: #f8f9fa;
      border: 2px solid #ddd;
      padding: 20px;
      margin: 20px 0;
      border-radius: 6px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .example {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 15px;
      margin: 15px 0;
    }
    .example-title {
      font-weight: bold;
      color: #2e7d32;
      margin-bottom: 10px;
    }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 15px 0;
    }
    .info {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      padding: 15px;
      margin: 15px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #34495e;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background: #f5f5f5;
    }
    .flow-diagram {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px 0;
    }
    .flow-step {
      background: #3498db;
      color: white;
      padding: 15px;
      border-radius: 6px;
      position: relative;
    }
    .flow-step::after {
      content: '↓';
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      color: #3498db;
    }
    .flow-step:last-child::after {
      display: none;
    }
    ul, ol {
      margin-left: 20px;
      margin-top: 10px;
    }
    li {
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav style="margin-bottom: 24px;">
      <a href="./index.html" style="margin-right: 16px; color: #3498db; text-decoration: none;">Calculator</a>
      <a href="./config.html" style="margin-right: 16px; color: #3498db; text-decoration: none;">Configuration</a>
      <a href="./documentation.html" style="margin-right: 16px; color: #3498db; text-decoration: none; font-weight: bold;">Documentation</a>
      <a href="./reference-data.html" style="color: #3498db; text-decoration: none;">Reference Data</a>
    </nav>
    <h1>Award Interpreter - System Documentation</h1>
    <p style="font-size: 1.1em; color: #666; margin-bottom: 30px;">
      This document explains how the Award Interpreter processes Fair Work Australia MAP CSV files,
      relates the data, and calculates shift costs.
    </p>

    <!-- Input Files Section -->
    <div class="section">
      <h2>1. Input Files</h2>
      <p>The system uses 5 CSV files exported from Fair Work Australia's MAP (Modern Awards Platform):</p>
      
      <div class="file-list">
        <div class="file-item">
          <strong>map-award-export-2025.csv</strong>
          <p>Contains award definitions: award codes, names, and metadata.</p>
          <p><em>Key fields:</em> <code>awardCode</code>, <code>awardFixedID</code>, <code>name</code></p>
        </div>
        
        <div class="file-item">
          <strong>map-classification-export-2025.csv</strong>
          <p>Contains employee classifications with base rates and calculated rates (including casual loading).</p>
          <p><em>Key fields:</em> <code>awardCode</code>, <code>employeeRateTypeCode</code> (CA/FT/PT), 
          <code>classification</code>, <code>classificationLevel</code>, <code>baseRate</code>, <code>baseRateType</code> (Weekly/Hourly),
          <code>calculatedRate</code>, <code>calculatedRateType</code>, <code>operativeFrom</code>, <code>operativeTo</code></p>
        </div>
        
        <div class="file-item">
          <strong>map-penalty-export-2025.csv</strong>
          <p>Contains penalty rates for different day types and scenarios (Saturday, Sunday, overtime, etc.).</p>
          <p><em>Key fields:</em> <code>awardCode</code>, <code>classification</code>, <code>classificationLevel</code>,
          <code>employeeRateTypeCode</code>, <code>penaltyDescription</code> (e.g., "Saturday - ordinary hours"),
          <code>rate</code> (percentage or dollar amount), <code>penaltyRateUnit</code> (Percentage/Hour),
          <code>penaltyCalculatedValue</code> (pre-calculated hourly rate in dollars)</p>
        </div>
        
        <div class="file-item">
          <strong>map-wage-allowance-export-2025.csv</strong>
          <p>Contains wage allowances (e.g., shift allowances, leading hand allowances).</p>
          <p><em>Key fields:</em> <code>awardCode</code>, <code>allowance</code>, <code>paymentFrequency</code> (Hourly/Per shift/Weekly),
          <code>rate</code>, <code>rateUnit</code>, <code>allowanceAmount</code></p>
        </div>
        
        <div class="file-item">
          <strong>map-expense-allowance-export-2025.csv</strong>
          <p>Contains expense allowances (e.g., travel, meal allowances).</p>
          <p><em>Key fields:</em> <code>awardCode</code>, <code>allowance</code>, <code>paymentFrequency</code> (Per km/Per shift),
          <code>allowanceAmount</code></p>
        </div>
      </div>
    </div>

    <!-- Data Loading Section -->
    <div class="section">
      <h2>2. Data Loading & Indexing</h2>
      
      <h3>2.1 CSV Parsing</h3>
      <p>CSV files are parsed with support for:</p>
      <ul>
        <li>Quoted fields containing commas</li>
        <li>Newlines within quoted fields</li>
        <li>Escaped quotes (<code>""</code> within quotes)</li>
      </ul>
      
      <h3>2.2 Operative Date Filtering</h3>
      <p>Only rows where today's date falls within the <code>operativeFrom</code> and <code>operativeTo</code> range are kept:</p>
      <pre><code>operativeFrom ≤ today ≤ operativeTo</code></pre>
      
      <h3>2.3 Data Indexes</h3>
      <p>Data is organized into multiple indexes for fast lookup:</p>
      
      <table>
        <tr>
          <th>Index</th>
          <th>Key</th>
          <th>Value</th>
          <th>Purpose</th>
        </tr>
        <tr>
          <td><code>awardsByCode</code></td>
          <td>Award code</td>
          <td>Award object</td>
          <td>Lookup award details</td>
        </tr>
        <tr>
          <td><code>classificationsByAward</code></td>
          <td>Award code</td>
          <td>Array of classifications</td>
          <td>All classifications for an award</td>
        </tr>
        <tr>
          <td><code>classificationsByAwardAndRateType</code></td>
          <td><code>"awardCode|rateType"</code></td>
          <td>Array of classifications</td>
          <td>Classifications filtered by employment type (CA/FT/PT)</td>
        </tr>
        <tr>
          <td><code>penaltiesByAward</code></td>
          <td>Award code</td>
          <td>Array of penalty rows</td>
          <td>All penalties for an award</td>
        </tr>
        <tr>
          <td><code>penaltiesByClassification</code></td>
          <td><code>"awardCode|classification|level"</code></td>
          <td>Array of penalty rows</td>
          <td>Penalties for a specific classification</td>
        </tr>
        <tr>
          <td><code>allowancesByAward</code></td>
          <td>Award code</td>
          <td><code>{ wage: [...], expense: [...] }</code></td>
          <td>Wage and expense allowances for an award</td>
        </tr>
      </table>
    </div>

    <!-- Data Relationships Section -->
    <div class="section">
      <h2>3. Data Relationships</h2>
      
      <div class="diagram">
Award (MA000004)
  ├── Classifications
  │   ├── Retail Employee Level 1 (CA) → baseRate: $1008.90/week, calculatedRate: $26.55/hour
  │   ├── Retail Employee Level 1 (FT) → baseRate: $1008.90/week, calculatedRate: $21.24/hour
  │   └── Retail Employee Level 2 (CA) → ...
  │
  ├── Penalties (matched by award + classification + rate type) — rates after validation (MA000004 CA Level 1)
  │   ├── "Saturday - ordinary hours" → $33.19/hour  [CSV overridden: flat ×1.25 on $26.55]
  │   ├── "Sunday - ordinary hours"   → $39.83/hour  [CSV overridden: ×1.50 on $26.55]
  │   └── "Public holiday"            → $59.74/hour  [×2.25 on $26.55]
  │
  └── Allowances
      ├── Wage: "Shift allowance - afternoon", "Leading hand allowance", ...
      └── Expense: "Meal allowance", "Travel allowance - per km", ...
      </div>
      <p><strong>Note:</strong> Raw CSV <code>penaltyCalculatedValue</code> figures may differ from the above. The multiplier validation layer (Section 4.3.1) detects and overrides out-of-range values. For MA000004 CA Level 1, tiered Saturday rows in the CSV are discarded — see Section 4.4.</p>
      
      <h3>3.1 Classification Selection</h3>
      <p>When a user selects:</p>
      <ul>
        <li><strong>Award:</strong> Filters to that award's data</li>
        <li><strong>Employment Type:</strong> Filters classifications by <code>employeeRateTypeCode</code> (CA = Casual, FT = Full-time, PT = Part-time)</li>
        <li><strong>Classification:</strong> Selects the specific classification row</li>
      </ul>
      
      <h3>3.2 Penalty Matching</h3>
      <p><strong>STEP 4 Fix:</strong> A penalty row applies if:</p>
      <ol>
        <li><code>penalty.awardCode === selectedAwardCode</code></li>
        <li><strong>Classification Matching (Tightened Logic):</strong>
          <ul>
            <li><strong>For non-AD penalties:</strong> <strong>BOTH</strong> <code>penalty.classification</code> <strong>AND</strong> <code>penalty.classificationLevel</code> must match the selected classification</li>
            <li><strong>For AD (applies to all) penalties:</strong> <code>penalty.classification</code> matches <strong>OR</strong> <code>penalty.classificationLevel</code> matches</li>
          </ul>
          <p><em>This prevents cross-contamination where Level 2 penalties incorrectly match Level 1 queries.</em></p>
        </li>
        <li><code>penalty.employeeRateTypeCode</code> matches selected rate type <strong>OR</strong> is "AD" (applies to all)</li>
      </ol>
      
      <div class="example">
        <div class="example-title">Example:</div>
        <p><strong>Selection:</strong> Award MA000004, Casual (CA), Retail Employee Level 1</p>
        <p><strong>Matching Penalties:</strong></p>
        <ul>
          <li>✓ "Saturday - ordinary hours" (CA, Retail Employee Level 1)</li>
          <li>✓ "Sunday - ordinary hours" (AD, Retail Employee Level 1)</li>
          <li>✗ "Overtime - Monday to Saturday" (FT, Retail Employee Level 1) - wrong rate type</li>
        </ul>
      </div>

      <h3>3.3 Engine inputs</h3>
      <p>The shift/roster cost engine uses the following inputs. All of these affect the final cost.</p>
      
      <table>
        <tr><th>Source</th><th>Input</th><th>Description</th></tr>
        <tr><td rowspan="10"><strong>User (UI)</strong></td><td>Award</td><td>Selected award code (e.g. MA000004)</td></tr>
        <tr><td>Employment type</td><td>Selected rate type (e.g. CA = Casual, FT, PT). Drives classification lookup and whether casual loading applies.</td></tr>
        <tr><td>Classification</td><td>Selected classification name (e.g. Retail Employee Level 1)</td></tr>
        <tr><td>Casual loading %</td><td>Number 0–100. Default 25. Persisted in localStorage. When user selects Casual and classification has weekly base, this is used to derive the ordinary hourly rate. <strong>0% is valid</strong> (no loading).</td></tr>
        <tr><td>Per shift: Date</td><td>Shift start date (YYYY-MM-DD)</td></tr>
        <tr><td>Per shift: Start time</td><td>Shift start time (HH:mm, 24h)</td></tr>
        <tr><td>Per shift: Duration (hrs)</td><td>Total shift length in hours</td></tr>
        <tr><td>Per shift: Break (min)</td><td>Unpaid break minutes; deducted from paid hours</td></tr>
        <tr><td>Per shift: Kms</td><td>Kilometres (for per-km expense allowances)</td></tr>
        <tr><td>Wage / expense allowances</td><td>Selected allowance types from the award</td></tr>
        <tr><td rowspan="3"><strong>Data (CSV + selection)</strong></td><td>Classification row</td><td><code>baseRate</code>, <code>baseRateType</code>, <code>calculatedRate</code>, <code>calculatedRateType</code>, <code>employeeRateTypeCode</code>, etc.</td></tr>
        <tr><td>Penalty rows</td><td>All penalties matching award + classification + level + rate type (see 3.2)</td></tr>
        <tr><td>Public holidays</td><td>Optional list of YYYY-MM-DD dates (e.g. from state/territory)</td></tr>
      </table>

      <h3>3.4 Calculation flow overview</h3>
      <p>High-level order of operations for a single shift:</p>
      <ol>
        <li><strong>Resolve ordinary hourly rate</strong> — From classification and (when applicable) Casual loading % (see Section 4.1).</li>
        <li><strong>Build penalty rate map</strong> — Map penalty keys (ordinary, saturday, sunday, etc.) to dollar rates; apply multiplier validation and MA000004 Saturday fix; when using casual loading for rate, set Sunday to ordinary × 1.50.</li>
        <li><strong>Segment the shift</strong> — Split shift into 6-minute segments by day type (public holiday, Sunday, Saturday, weekday) and time-of-day (before 7am, 7am–6pm, after 6pm; Friday late). Apply overtime after 9 ordinary hours.</li>
        <li><strong>Apply casual minimum engagement</strong> — If casual and paid hours &lt; 3, pad to 3 hours at the shift’s day-type rate.</li>
        <li><strong>Sum segment costs</strong> — For each segment: hours × rate from penalty map.</li>
        <li><strong>Add wage and expense allowances</strong> — Using same effective hourly rate for percentage-based allowances.</li>
        <li><strong>Return</strong> segments, allowances, total cost, total hours, and warnings.</li>
      </ol>
    </div>

    <!-- Rate Calculation Section -->
    <div class="section">
      <h2>4. Rate Calculation Logic</h2>
      
      <h3>4.0 Casual loading and “use loading for rate”</h3>
      <p>The UI exposes a <strong>Casual loading %</strong> field (0–100, default 25, persisted). The engine uses it only when <strong>both</strong> of the following are true:</p>
      <ul>
        <li>The user has selected <strong>Employment type: Casual (CA)</strong> (from the dropdown).</li>
        <li>The selected classification has a <strong>weekly</strong> base rate (<code>baseRateType</code> = "Weekly" and <code>baseRate</code> present).</li>
      </ul>
      <p>When both are true, the engine treats this as “use casual loading for rate”: the <strong>ordinary hourly rate</strong> is derived from the weekly base plus the user’s loading %, and the same rate is used consistently for the shift (and for percentage-based allowances). When the user has set 0%, the multiplier is 1.00 (no loading). Default 25% is used only when the value is missing or not a number.</p>
      <pre><code>loadingMultiplier = 1 + (casualLoadingPercent / 100)   // 0% → 1.00, 25% → 1.25
ordinaryHourly = (baseRate ÷ 38) × loadingMultiplier    // when "use loading for rate"</code></pre>
      <p>The <strong>“Calculated rate”</strong> shown in the Base and penalty rates panel uses this same formula when Casual is selected and the classification has a weekly base, so the displayed rate matches the rate used in the roster cost breakdown.</p>
      
      <h3>4.1 Ordinary hourly rate derivation</h3>
      <p>The system derives the ordinary hourly rate used for the shift in this order:</p>
      
      <div class="flow-diagram">
        <div class="flow-step">
          <strong>Step 1 (use casual loading for rate):</strong> If the UI has set “use loading for rate” (user selected Casual and classification has weekly base), then:<br>
          <code>ordinaryHourly = (baseRate ÷ 38) × (1 + casualLoadingPercent/100)</code><br>
          <em>This overrides the CSV calculated rate so the user’s Casual loading % is always applied when applicable. 0% gives base/38.</em>
        </div>
        <div class="flow-step">
          <strong>Step 2 (CSV hourly rate):</strong> If <code>calculatedRateType</code> is "Hourly" and <code>calculatedRate</code> exists, use <code>calculatedRate</code>.
        </div>
        <div class="flow-step">
          <strong>Step 3 (weekly fallback):</strong> If <code>baseRateType</code> is "Weekly" and <code>baseRate</code> exists:<br>
          For <strong>Casual (CA):</strong> <code>ordinaryHourly = (baseRate ÷ 38) × loadingMultiplier</code><br>
          For <strong>Full-time/Part-time:</strong> <code>ordinaryHourly = baseRate ÷ 38</code>
        </div>
        <div class="flow-step">
          <strong>Step 4:</strong> Otherwise use <code>calculatedRate</code> if available.
        </div>
      </div>
      
      <div class="example">
        <div class="example-title">Example – Casual, weekly base, 25% loading:</div>
        <ul>
          <li><code>baseRate</code>: $1008.90/week</li>
          <li>Casual loading %: 25</li>
          <li><strong>Result:</strong> ordinaryHourly = (1008.90 ÷ 38) × 1.25 = $33.19/hour (used for shift and for percentage allowances)</li>
        </ul>
      </div>
      <div class="example">
        <div class="example-title">Example – Casual, weekly base, 0% loading:</div>
        <ul>
          <li><code>baseRate</code>: $1008.90/week</li>
          <li>Casual loading %: 0</li>
          <li><strong>Result:</strong> ordinaryHourly = (1008.90 ÷ 38) × 1.00 = $26.55/hour</li>
        </ul>
      </div>
      
      <h3>4.2 Penalty Rate Mapping</h3>
      <p>Penalty descriptions are normalized to internal keys:</p>
      
      <table>
        <tr>
          <th>Penalty Description</th>
          <th>Internal Key</th>
          <th>Notes</th>
        </tr>
        <tr>
          <td>"Saturday - ordinary hours"</td>
          <td><code>saturday_ordinary</code></td>
          <td>Saturday-specific ordinary rate</td>
        </tr>
        <tr>
          <td>"Saturday - first 3 hours"</td>
          <td><code>saturday_first_3</code></td>
          <td>First X hours of work on Saturday</td>
        </tr>
        <tr>
          <td>"Saturday - after 3 hours"</td>
          <td><code>saturday_after_3</code></td>
          <td>Hours after first X hours on Saturday</td>
        </tr>
        <tr>
          <td>"Sunday - ordinary hours"</td>
          <td><code>sunday</code></td>
          <td>All Sunday hours</td>
        </tr>
        <tr>
          <td>"Public holiday"</td>
          <td><code>publicholiday</code></td>
          <td>Public holiday hours</td>
        </tr>
        <tr>
          <td>"Monday - ordinary hours"</td>
          <td><code>ordinary</code></td>
          <td>Weekday ordinary hours (Mon-Fri)</td>
        </tr>
      </table>
      
      <h3>4.3 Penalty Rate Value</h3>
      <p>For each penalty, the system prefers:</p>
      <ol>
        <li><code>penaltyCalculatedValue</code> (pre-calculated hourly rate in dollars)</li>
        <li>If percentage: <code>ordinaryHourlyRate × (rate ÷ 100)</code></li>
        <li>If dollar amount: use <code>rate</code> directly</li>
      </ol>
      
      <h3>4.3.1 Multiplier Validation Layer (Data Quality Protection)</h3>
      <p><strong>STEP 2 Implementation:</strong> For MA000004 Casual Level 1 employees, the system includes a multiplier validation layer that protects against incorrect CSV data:</p>
      <ul>
        <li><strong>Expected Multiplier Ranges:</strong> Each penalty key has an expected multiplier range:
          <table>
            <tr><th>Penalty Key</th><th>Expected Multiplier</th><th>Range</th></tr>
            <tr><td><code>ordinary</code></td><td>×1.00</td><td>0.98 - 1.02</td></tr>
            <tr><td><code>weekday_early_late</code></td><td>×1.10</td><td>1.08 - 1.12</td></tr>
            <tr><td><code>friday_late</code></td><td>×1.15</td><td>1.13 - 1.17</td></tr>
            <tr><td><code>saturday</code> / <code>saturday_ordinary</code></td><td>×1.25</td><td>1.23 - 1.27</td></tr>
            <tr><td><code>sunday</code></td><td>×1.50</td><td>1.48 - 1.52</td></tr>
            <tr><td><code>publicholiday</code></td><td>×2.25</td><td>2.23 - 2.27</td></tr>
          </table>
        </li>
        <li><strong>Validation Process:</strong>
          <ol>
            <li>Calculate implied multiplier: <code>impliedMultiplier = penaltyCalculatedValue ÷ ordinaryHourlyRate</code></li>
            <li>Compare against expected range for that penalty key</li>
            <li>If outside range (±0.02 tolerance): Log DATA QUALITY WARNING and override with calculated rate</li>
            <li>Override rate: <code>ordinaryHourlyRate × expectedMultiplier</code></li>
          </ol>
        </li>
        <li><strong>Warning Messages:</strong> When an override is applied, a warning is added to the API response:
          <pre><code>"Rate override applied for [key]: CSV value $X.XX implies ×Y.YY which is outside expected range (min-max). Using calculated rate $Z.ZZ instead. Source row: [description] ([rateType], Level [level])"</code></pre>
        </li>
        <li><strong>Rationale:</strong> This validation layer ensures that incorrect <code>penaltyCalculatedValue</code> figures from the MAP CSV (or penalties matched from wrong classifications) do not produce incorrect shift costs. The system automatically corrects data quality issues while alerting users to the problem.</li>
      </ul>
      
      <h3>4.4 Saturday Penalty Verification (BUG 4 Fix)</h3>
      <p>The system checks whether tiered Saturday rates exist in the MAP CSV data and whether they are legitimate for the selected award/classification/rate type:</p>
      <ul>
        <li><strong>MA000004 CA Level 1 (known exception):</strong> Tiered Saturday rows (<code>saturday_first_X</code>, <code>saturday_after_X</code>) are always discarded for this classification regardless of what the CSV contains. This is a confirmed data quality issue — the tiered rows in the CSV do not represent the correct award entitlement for this classification. The flat Saturday rate (×1.25 on ordinary hourly rate) is always used for all Saturday hours.</li>
        <li><strong>Other awards/classifications:</strong> If tiered rates exist and their implied multipliers pass the validation check in Section 4.3.1, tiered logic is applied. If only a flat rate exists (<code>saturday_ordinary</code> or generic <code>saturday</code>), the flat rate is used for all Saturday hours.</li>
        <li><strong>Consistency check:</strong> If the Saturday ordinary rate exceeds the Sunday rate after validation, a warning is generated.</li>
      </ul>
      
      <h3>4.5 Sunday rate and validation (BUG 5 Fix)</h3>
      <p>When the engine is <strong>using casual loading for the ordinary rate</strong> (user selected Casual and classification has weekly base), the CSV Sunday rate is often based on the unloaded rate (e.g. 26.55 × 1.50 = 39.83). The engine therefore <strong>overrides</strong> the Sunday penalty rate to:</p>
      <pre><code>sundayRate = ordinaryHourly × 1.50</code></pre>
      <p>so that Sunday costs and validation stay consistent with the loaded ordinary rate. When not using casual loading for rate, the Sunday rate from the penalty map is used as-is.</p>
      <p>The system also validates that the Sunday rate equals ordinary × 1.50. If the value in the map (after any override) differs beyond tolerance, a validation warning is generated:</p>
      <pre><code>Expected Sunday rate = ordinaryHourlyRate × 1.50</code></pre>
      
      <div class="info">
        <strong>Important:</strong> The "ordinary" key is set from the derived ordinary hourly rate as a fallback.
        If a penalty row maps to "ordinary" (e.g., "Monday - ordinary hours"), it may override this fallback.
      </div>
    </div>

    <!-- Shift Cost Calculation Section -->
    <div class="section">
      <h2>5. Shift Cost Calculation</h2>
      <p>For each shift, the engine computes <strong>paid hours</strong> (duration minus unpaid break), splits that time into segments by day type and time-of-day, looks up the rate for each segment from the penalty map, then sums costs and adds allowances:</p>
      <pre><code>segmentCost = segmentHours × ratePerHour   (rate from penalty map for that segment's key)
shiftCost = Σ segmentCosts + Σ wageAllowanceCosts + Σ expenseAllowanceCosts</code></pre>
      <p>Standard full-time week is 38 hours (Fair Work); weekly base rates are divided by 38 to get an hourly equivalent.</p>
      
      <h3>5.0 Weekday Time-of-Day Penalties (BUG 1 Fix)</h3>
      <p>The system now splits weekday shifts by time boundaries and applies appropriate penalty rates:</p>
      <table>
        <tr>
          <th>Time Window</th>
          <th>Day</th>
          <th>Penalty Key</th>
          <th>Multiplier</th>
        </tr>
        <tr>
          <td>Before 7:00am</td>
          <td>Mon-Fri</td>
          <td><code>weekday_early_late</code></td>
          <td>×1.10</td>
        </tr>
        <tr>
          <td>7:00am - 6:00pm</td>
          <td>Mon-Fri</td>
          <td><code>ordinary</code></td>
          <td>×1.00</td>
        </tr>
        <tr>
          <td>After 6:00pm</td>
          <td>Mon-Thu</td>
          <td><code>weekday_early_late</code></td>
          <td>×1.10</td>
        </tr>
        <tr>
          <td>After 6:00pm</td>
          <td>Friday</td>
          <td><code>friday_late</code></td>
          <td>×1.15</td>
        </tr>
      </table>
      <div class="example">
        <div class="example-title">Example:</div>
        <p><strong>Shift:</strong> Thursday, 5:00pm-9:00pm (4 hours)</p>
        <ul>
          <li>5:00pm-6:00pm: Ordinary hours (1 hr × $26.55 = $26.55)</li>
          <li>6:00pm-9:00pm: Weekday early/late (3 hrs × $29.21 = $87.63)</li>
          <li><strong>Total:</strong> $114.18</li>
        </ul>
      </div>
      
      <h3>5.1 Weekday Overtime Logic (BUG 2 Fix)</h3>
      <p>After 9 ordinary hours per day, overtime multipliers apply:</p>
      <ul>
        <li><strong>First 3 hours of overtime:</strong> ×1.50 multiplier</li>
        <li><strong>Beyond 3 hours of overtime:</strong> ×2.00 multiplier</li>
      </ul>
      <p><strong>Important:</strong> Overtime multipliers are applied on top of whichever time-of-day penalty is active at that moment.</p>
      <div class="example">
        <div class="example-title">Example:</div>
        <p><strong>Shift:</strong> Monday, 10:00am-10:00pm (12 hours)</p>
        <ul>
          <li>10:00am-6:00pm: Ordinary hours (8 hrs × $26.55 = $212.40)</li>
          <li>6:00pm-7:00pm: Weekday early/late (1 hr × $29.21 = $29.21)</li>
          <li>7:00pm-10:00pm: Weekday early/late + overtime first 3 hrs (3 hrs × $43.81 = $131.43)</li>
          <li><strong>Total:</strong> $373.04</li>
        </ul>
        <p><em>Note: Rate calculation = $26.55 × 1.10 (late) × 1.50 (overtime) = $43.81/hr</em></p>
      </div>
      
      <h3>5.2 Casual Minimum Engagement (BUG 3 Fix)</h3>
      <p><strong>MA000004 Clause 13.3:</strong> Casual employees must be paid a minimum of 3 hours per engagement, regardless of actual hours worked.</p>
      <ul>
        <li>If paid hours &lt; 3, the system pads to 3 hours</li>
        <li><strong>FIX 1:</strong> Padding hours are charged at the <strong>shift's day-type rate</strong>, not always the ordinary rate:
          <ul>
            <li>Weekday shift → padding at ordinary weekday rate</li>
            <li>Saturday shift → padding at applicable Saturday rate (saturday_ordinary or saturday)</li>
            <li>Sunday shift → padding at Sunday rate (×1.50)</li>
            <li>Public holiday shift → padding at public holiday rate</li>
          </ul>
        </li>
        <li>A warning is added to the response: "Minimum casual engagement of 3 hours applied"</li>
        <li>Applies to all day types (weekdays, weekends, public holidays)</li>
      </ul>
      <div class="example">
        <div class="example-title">Example - Sunday Shift:</div>
        <p><strong>Shift:</strong> Sunday, 2 hours worked</p>
        <ul>
          <li>Actual hours: 2 hours</li>
          <li>Minimum engagement: 3 hours</li>
          <li>Padding: 1 hour at <strong>Sunday rate</strong> (×1.50 on casual loaded rate)</li>
          <li><strong>Total paid hours:</strong> 3 hours</li>
        </ul>
        <p><em>Note: The padding hour is charged at the Sunday rate, not the ordinary weekday rate, because the shift occurs on a Sunday.</em></p>
      </div>
      <div class="example">
        <div class="example-title">Example - Saturday Shift:</div>
        <p><strong>Shift:</strong> Saturday, 2 hours worked</p>
        <ul>
          <li>Actual hours: 2 hours</li>
          <li>Minimum engagement: 3 hours</li>
          <li>Padding: 1 hour at the flat Saturday rate (×1.25 on ordinary hourly rate = $33.19/hr)</li>
          <li><strong>Total paid hours:</strong> 3 hours</li>
        </ul>
      </div>
      
      <h3>5.3 Shift Segmentation</h3>
      <p>The system processes a shift in 6-minute increments, determining the penalty key for each moment:</p>
      
      <div class="flow-diagram">
        <div class="flow-step">
          <strong>For each 6-minute segment:</strong>
          <br>1. Check if it's a public holiday → <code>publicholiday</code>
          <br>2. Check if it's Sunday → <code>sunday</code>
          <br>3. Check if it's Saturday → apply Saturday logic
          <br>4. Otherwise → apply weekday time-of-day logic (see Section 5.0):
          <br>&nbsp;&nbsp;&nbsp;&nbsp;• Before 7am = <code>weekday_early_late</code> (×1.10)
          <br>&nbsp;&nbsp;&nbsp;&nbsp;• 7am–6pm = <code>ordinary</code> (×1.00)
          <br>&nbsp;&nbsp;&nbsp;&nbsp;• After 6pm Mon–Thu = <code>weekday_early_late</code> (×1.10)
          <br>&nbsp;&nbsp;&nbsp;&nbsp;• After 6pm Fri = <code>friday_late</code> (×1.15)
        </div>
        <div class="flow-step">
          <strong>Saturday Logic:</strong>
          <br>1. Track hours worked in shift (excluding breaks)
          <br>2. If hours worked &lt; X and "saturday_first_X" exists → use that
          <br>3. If "saturday_after_X" exists → use that
          <br>4. If "saturday_ordinary" exists → use that
          <br>5. Fallback to generic "saturday" or "ordinary"
        </div>
      </div>
      
      <div class="example">
        <div class="example-title">Example - Saturday Shift (MA000004 CA Level 1):</div>
        <p><strong>Shift:</strong> Saturday, 09:00-14:00 (5 hours), 30 min break</p>
        <p><strong>Paid hours:</strong> 4.5 hours</p>
        <p><strong>Calculation:</strong></p>
        <ul>
          <li>All hours: 4.5 hrs at flat Saturday rate (×1.25)</li>
          <li>4.5 hrs × $33.19 = $149.36</li>
        </ul>
        <p><em>Note: For MA000004 CA Level 1, tiered Saturday rates are not used; see Section 4.4.</em></p>
      </div>
      
      <h3>5.2 Segment Accumulation</h3>
      <p>Segments with the same penalty key are accumulated:</p>
      <pre><code>Saturday - all hours: 4.5 hrs × $33.19 = $149.36
Total shift cost: $149.36</code></pre>
      
      <h3>5.3 Break Deduction</h3>
      <p>Unpaid breaks are excluded from paid hours:</p>
      <ul>
        <li>Break time is skipped during segmentation</li>
        <li>Only worked time is charged</li>
      </ul>
      
      <div class="example">
        <div class="example-title">Example:</div>
        <p><strong>Shift:</strong> 8 hours duration, 30 min break</p>
        <p><strong>Paid hours:</strong> 7.5 hours</p>
        <p>The 30-minute break period is not included in any segment's cost calculation.</p>
      </div>
    </div>

    <!-- Allowance Calculation Section -->
    <div class="section">
      <h2>6. Allowance Calculations</h2>
      <p>Allowances use the same <strong>effective ordinary hourly rate</strong> as the shift when they are percentage-based: that rate is passed from the shift cost engine (and includes casual loading when “use loading for rate” applies). So wage allowances stay consistent with the rate shown in the roster breakdown.</p>
      
      <h3>6.1 Wage Allowances</h3>
      <p>Wage allowances are calculated based on <code>paymentFrequency</code> and <code>rateUnit</code>:</p>
      
      <table>
        <tr>
          <th>Payment Frequency</th>
          <th>Calculation</th>
          <th>Example</th>
        </tr>
        <tr>
          <td>Hourly / Per hour</td>
          <td><code>allowanceAmount × paidHours</code> (or <code>rate × paidHours</code>)</td>
          <td>$2.50/hour × 7.5 hrs = $18.75</td>
        </tr>
        <tr>
          <td>Per shift / Per day</td>
          <td><code>allowanceAmount</code> (flat rate)</td>
          <td>$15.00 per shift</td>
        </tr>
        <tr>
          <td>Weekly</td>
          <td><code>(allowanceAmount ÷ 38) × paidHours</code></td>
          <td>($50/week ÷ 38) × 7.5 hrs = $9.87</td>
        </tr>
        <tr>
          <td>Percentage (hourly)</td>
          <td><code>(effectiveHourlyRate × rate%) × paidHours</code></td>
          <td>Same hourly rate as shift (e.g. $33.19 if 25% loading)</td>
        </tr>
        <tr>
          <td>Percentage (per shift)</td>
          <td><code>(effectiveHourlyRate × rate%) × 8</code></td>
          <td>Same hourly rate as shift; 8 = standard shift hours</td>
        </tr>
      </table>
      
      <h3>6.2 Expense Allowances</h3>
      <p>Expense allowances are calculated based on <code>paymentFrequency</code>:</p>
      
      <table>
        <tr>
          <th>Payment Frequency</th>
          <th>Calculation</th>
          <th>Example</th>
        </tr>
        <tr>
          <td>Per km / Per kilometre</td>
          <td><code>allowanceAmount × shiftKms</code></td>
          <td>$0.85/km × 50 km = $42.50</td>
        </tr>
        <tr>
          <td>Per shift / Per day / Per occasion</td>
          <td><code>allowanceAmount</code> (flat rate)</td>
          <td>$12.00 per shift</td>
        </tr>
        <tr>
          <td>For each meal</td>
          <td><code>allowanceAmount</code> (assumes 1 meal per shift)</td>
          <td>$8.50 per meal</td>
        </tr>
      </table>
    </div>

    <!-- Roster Calculation Section -->
    <div class="section">
      <h2>7. Roster Cost Calculation</h2>
      <p>For multiple shifts:</p>
      <ol>
        <li>Each shift is calculated independently using the logic above</li>
        <li>Shift costs are summed</li>
        <li>Total hours are summed</li>
        <li>Allowances are calculated per shift (not aggregated)</li>
      </ol>
      
      <div class="example">
        <div class="example-title">Example Roster:</div>
        <p><strong>Shift 1:</strong> Wednesday, 5 hrs → $132.75 (ordinary hours, 9am–2pm)</p>
        <p><strong>Shift 2:</strong> Saturday, 5 hrs → $165.94 (flat Saturday rate, 5 hrs × $33.19)</p>
        <p><strong>Total:</strong> 10 hrs, $298.69</p>
      </div>
    </div>

    <!-- Key Design Decisions Section -->
    <div class="section">
      <h2>8. Key Design Decisions</h2>
      
      <h3>8.1 Saturday "First X Hours" Logic</h3>
      <div class="info">
        <strong>Decision:</strong> "First X hours" refers to the first X hours <strong>worked in the shift</strong>, not hours since midnight.
        <br><br>
        <strong>Rationale:</strong> Awards typically specify "first X hours of work" on Saturday, meaning the first X hours of the employee's shift, not the first X hours of the calendar day.
      </div>
      
      <h3>8.2 Penalty Rate Precedence</h3>
      <div class="info">
        <strong>Decision:</strong> Penalty rows can override the classification's ordinary rate if they map to the "ordinary" key.
        <br><br>
        <strong>Rationale:</strong> Some penalty rows (e.g., "Monday - ordinary hours") may specify rates that already include casual loading or other adjustments, so they should take precedence over the base classification rate.
      </div>
      
      <h3>8.3 Saturday Ordinary Hours</h3>
      <div class="info">
        <strong>Decision:</strong> "Saturday - ordinary hours" maps to <code>saturday_ordinary</code>, not generic <code>ordinary</code>.
        <br><br>
        <strong>Rationale:</strong> Saturday has its own ordinary rate that differs from weekday ordinary rates, so it needs a separate key to be applied correctly.
      </div>
    </div>

    <!-- Summary Section -->
    <div class="section">
      <h2>9. Summary</h2>
      <p>The Award Interpreter system:</p>
      <ol>
        <li><strong>Loads</strong> 5 CSV files and indexes them by award, classification, and rate type</li>
        <li><strong>Accepts</strong> user inputs: award, employment type, classification, Casual loading % (0–100), and per-shift date, start time, duration, break, kms, and selected allowances (see Section 3.3)</li>
        <li><strong>Matches</strong> penalties and allowances to the selected award/classification/level/rate type (Section 3.2)</li>
        <li><strong>Derives</strong> the ordinary hourly rate: when user selected Casual and classification has weekly base, uses (base÷38)×(1 + casualLoadingPercent/100); otherwise uses CSV calculated rate or weekly fallback (Section 4.1)</li>
        <li><strong>Builds</strong> the penalty rate map from matched penalties, with multiplier validation, MA000004 Saturday flat-rate fix, and when using casual loading for rate, Sunday = ordinary × 1.50 (Sections 4.2–4.5)</li>
        <li><strong>Maps</strong> penalty descriptions to internal keys (ordinary, saturday_ordinary, sunday, etc.) for lookup</li>
        <li><strong>Segments</strong> shifts by day type, time-of-day boundaries, and hours worked (6-minute precision)</li>
        <li><strong>Applies</strong> weekday time-of-day penalties (before 7am, 7am–6pm, after 6pm; Friday late ×1.15)</li>
        <li><strong>Calculates</strong> overtime multipliers (×1.50 first 3 hrs, ×2.00 beyond) on top of time-of-day penalties</li>
        <li><strong>Enforces</strong> casual minimum engagement (3 hours) with padding at the shift’s day-type rate and warnings</li>
        <li><strong>Validates</strong> penalty rates (Saturday/Sunday consistency, Sunday ×1.50); overrides Sunday when using casual loading for rate</li>
        <li><strong>Calculates</strong> costs per segment using the penalty map</li>
        <li><strong>Adds</strong> wage and expense allowances (percentage wage allowances use the same effective hourly rate as the shift)</li>
        <li><strong>Sums</strong> all segments and allowances for total shift/roster cost</li>
        <li><strong>Returns</strong> segments, allowances, total cost, total hours, and warnings</li>
      </ol>
    </div>
    
    <!-- Bug Fixes Section -->
    <div class="section">
      <h2>10. Recent Bug Fixes (February 2026)</h2>
      <p>The following bugs were identified and fixed in a code review:</p>
      <ul>
        <li><strong>BUG 1:</strong> Weekday time-of-day penalties now correctly applied (before 7am, 7am-6pm, after 6pm)</li>
        <li><strong>BUG 2:</strong> Weekday overtime logic implemented (max 9 ordinary hours, then ×1.50/×2.00 multipliers)</li>
        <li><strong>BUG 3:</strong> Casual minimum engagement enforced (3 hours minimum with padding at day-type rate)</li>
        <li><strong>BUG 4:</strong> Saturday penalty rate verification; MA000004 CA Level 1 uses flat ×1.25 (no tiered Saturday)</li>
        <li><strong>BUG 5:</strong> Sunday rate multiplier validation (×1.50); Sunday overridden to ordinary×1.50 when using casual loading for rate</li>
        <li><strong>BUG 6:</strong> Casual loading: user-setting “Casual loading %” (0–100, default 25) applied when user selects Casual and classification has weekly base; 0% respected (no longer treated as 25%)</li>
      </ul>
      <p>Additional behaviour: “Calculated rate” in the UI reflects the same effective rate used in shift cost when Casual + weekly base; percentage-based wage allowances use that same effective hourly rate. All fixes include comprehensive unit tests in <code>tests/shift-cost-bugs.test.js</code>.</p>
    </div>

    <div style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #ecf0f1; color: #666; font-size: 0.9em;">
      <p><em>Documentation generated for Award Interpreter system</em></p>
      <p><em>Last updated: February 2026</em></p>
    </div>
  </div>
</body>
</html>